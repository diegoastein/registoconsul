<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro Neonatal y Análisis</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN para gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <!-- Configuración para usar la fuente Inter -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Fondo gris claro */
        }
        /* Estilo para asegurar que el modal de edición esté visible */
        .modal-active {
            display: flex;
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
        <div class="text-white text-xl font-semibold">Cargando aplicación y base de datos...</div>
    </div>

    <div id="main-content" class="max-w-4xl mx-auto space-y-8 hidden">
        <h1 class="text-3xl font-bold text-center text-indigo-700">Registro y Análisis Neonatal</h1>
        <p id="user-info" class="text-center text-sm text-gray-600 mb-4"></p>

        <!-- Sección de Formulario de Ingreso de Datos -->
        <div class="bg-white p-6 rounded-xl shadow-lg">
            <h2 class="text-xl font-semibold mb-4 text-gray-700">Ingresar Nuevo Registro</h2>
            <form id="neonatal-form" class="space-y-4">
                
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <!-- DNI (Unique key) -->
                    <div>
                        <label for="dni" class="block text-sm font-medium text-gray-700">DNI/ID del Paciente (Debe ser único)</label>
                        <input type="text" id="dni" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <!-- Fecha de Nacimiento -->
                    <div>
                        <label for="birthDate" class="block text-sm font-medium text-gray-700">Fecha de Nacimiento</label>
                        <input type="date" id="birthDate" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                </div>

                <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                    <!-- Peso al nacer (gr.) -->
                    <div>
                        <label for="birthWeight" class="block text-sm font-medium text-gray-700">Peso al Nacer (gr.)</label>
                        <input type="number" id="birthWeight" min="100" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <!-- Edad gestacional (sem) -->
                    <div>
                        <label for="gestationalAge" class="block text-sm font-medium text-gray-700">Edad Gestacional (sem.)</label>
                        <input type="number" id="gestationalAge" min="20" max="45" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <!-- Apgar -->
                    <div>
                        <label for="apgar" class="block text-sm font-medium text-gray-700">Puntaje Apgar</label>
                        <input type="number" id="apgar" min="1" max="10" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <!-- Edad Materna -->
                    <div>
                        <label for="maternalAge" class="block text-sm font-medium text-gray-700">Edad Materna</label>
                        <input type="number" id="maternalAge" min="15" max="60" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <!-- Parto o cesarea -->
                    <div>
                        <label for="deliveryType" class="block text-sm font-medium text-gray-700">Tipo de Parto</label>
                        <select id="deliveryType" required class="mt-1 block w-full p-3 border border-gray-300 bg-white rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="">Seleccione...</option>
                            <option value="Parto">Parto Vaginal</option>
                            <option value="Cesarea">Cesárea</option>
                        </select>
                    </div>
                    <!-- Días de internacion en Neo -->
                    <div>
                        <label for="nicuDays" class="block text-sm font-medium text-gray-700">Días de Internación en Neo</label>
                        <input type="number" id="nicuDays" min="0" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                </div>
                
                <!-- Otros -->
                <div>
                    <label for="notes" class="block text-sm font-medium text-gray-700">Otros / Observaciones</label>
                    <textarea id="notes" rows="3" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                </div>

                <button type="submit" id="save-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg transition duration-200 shadow-lg disabled:opacity-50">Guardar Registro</button>
                <div id="form-message" class="mt-2 text-sm text-center"></div>

            </form>
        </div>
        
        <!-- Sección de Estadísticas y Promedios -->
        <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-indigo-500">
            <h2 class="text-xl font-semibold mb-4 text-indigo-600">Promedios Globales (n = <span id="record-count">0</span>)</h2>
            <div id="averages-display" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="p-3 bg-indigo-50 rounded-lg text-center">
                    <p class="text-sm text-gray-500">Peso al Nacer (gr.)</p>
                    <p id="avg-birthWeight" class="text-2xl font-bold text-indigo-800">-</p>
                </div>
                <div class="p-3 bg-indigo-50 rounded-lg text-center">
                    <p class="text-sm text-gray-500">Edad Gestacional</p>
                    <p id="avg-gestationalAge" class="text-2xl font-bold text-indigo-800">-</p>
                </div>
                <div class="p-3 bg-indigo-50 rounded-lg text-center">
                    <p class="text-sm text-gray-500">Días en Neo</p>
                    <p id="avg-nicuDays" class="text-2xl font-bold text-indigo-800">-</p>
                </div>
                <div class="p-3 bg-indigo-50 rounded-lg text-center">
                    <p class="text-sm text-gray-500">Edad Materna</p>
                    <p id="avg-maternalAge" class="text-2xl font-bold text-indigo-800">-</p>
                </div>
            </div>
            
            <!-- Botón de Exportar a CSV (Nueva Característica) -->
            <button onclick="exportToCSV()" id="export-btn" class="mt-6 w-full sm:w-auto bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200 shadow-md disabled:opacity-50">
                Exportar Datos a CSV
            </button>
        </div>

        <!-- Sección de Gráfico (Nueva Característica) -->
        <div class="bg-white p-6 rounded-xl shadow-lg">
            <h2 class="text-xl font-semibold mb-4 text-gray-700">Distribución de Peso al Nacer</h2>
            <div class="relative h-64">
                <canvas id="birthWeightChart"></canvas>
            </div>
        </div>

        <!-- Sección de Búsqueda por DNI -->
        <div class="bg-white p-6 rounded-xl shadow-lg">
            <h2 class="text-xl font-semibold mb-4 text-gray-700">Buscar Registro por DNI (Editar/Eliminar)</h2>
            <div class="flex flex-col sm:flex-row gap-3">
                <input type="text" id="search-dni" placeholder="Ingrese DNI/ID a buscar" class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                <button onclick="searchRecord()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition duration-200 shadow-md">Buscar</button>
            </div>
            
            <div id="search-results" class="mt-4 p-4 border border-dashed border-gray-300 rounded-lg bg-gray-50 min-h-[50px] flex items-center justify-center text-gray-500">
                Aún no se ha realizado ninguna búsqueda.
            </div>
        </div>
    </div>

    <!-- Modals para errores y mensajes (Normal) -->
    <div id="modal-container" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full">
            <h3 id="modal-title" class="text-lg font-bold mb-3 text-red-600">Error</h3>
            <p id="modal-body" class="text-gray-700 mb-4">Ha ocurrido un error inesperado.</p>
            <button onclick="closeModal()" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 rounded-lg transition duration-200">Cerrar</button>
        </div>
    </div>

    <!-- Modal para Edición de Registro (NUEVO) -->
    <div id="edit-modal-container" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-xl w-full mx-4 sm:mx-0">
            <h3 class="text-xl font-bold mb-4 text-indigo-600">Editar Registro: <span id="edit-dni-display"></span></h3>
            <form id="edit-neonatal-form" class="space-y-4">
                <input type="hidden" id="edit-record-id">
                
                <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                    <!-- Solo lectura para DNI -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700">DNI/ID</label>
                        <input type="text" id="edit-dni" class="mt-1 block w-full p-3 border border-gray-300 bg-gray-100 rounded-lg" readonly>
                    </div>
                    <!-- Fecha de Nacimiento -->
                    <div>
                        <label for="edit-birthDate" class="block text-sm font-medium text-gray-700">Fecha Nacimiento</label>
                        <input type="date" id="edit-birthDate" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <!-- Peso al nacer (gr.) -->
                    <div>
                        <label for="edit-birthWeight" class="block text-sm font-medium text-gray-700">Peso (gr.)</label>
                        <input type="number" id="edit-birthWeight" min="100" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <!-- Edad gestacional (sem) -->
                    <div>
                        <label for="edit-gestationalAge" class="block text-sm font-medium text-gray-700">Edad Gest. (sem.)</label>
                        <input type="number" id="edit-gestationalAge" min="20" max="45" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                </div>

                <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                    <!-- Apgar -->
                    <div>
                        <label for="edit-apgar" class="block text-sm font-medium text-gray-700">Apgar</label>
                        <input type="number" id="edit-apgar" min="1" max="10" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <!-- Edad Materna -->
                    <div>
                        <label for="edit-maternalAge" class="block text-sm font-medium text-gray-700">Edad Materna</label>
                        <input type="number" id="edit-maternalAge" min="15" max="60" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                     <!-- Parto o cesarea -->
                    <div>
                        <label for="edit-deliveryType" class="block text-sm font-medium text-gray-700">Tipo de Parto</label>
                        <select id="edit-deliveryType" required class="mt-1 block w-full p-3 border border-gray-300 bg-white rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="Parto">Parto Vaginal</option>
                            <option value="Cesarea">Cesárea</option>
                        </select>
                    </div>
                    <!-- Días de internacion en Neo -->
                    <div>
                        <label for="edit-nicuDays" class="block text-sm font-medium text-gray-700">Días en Neo</label>
                        <input type="number" id="edit-nicuDays" min="0" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                </div>
                
                <!-- Otros -->
                <div>
                    <label for="edit-notes" class="block text-sm font-medium text-gray-700">Otros / Observaciones</label>
                    <textarea id="edit-notes" rows="2" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                </div>

                <div id="edit-form-message" class="mt-2 text-sm text-center"></div>

                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="closeEditModal()" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg transition duration-200">Cancelar</button>
                    <button type="submit" id="save-edit-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200 disabled:opacity-50">Guardar Cambios</button>
                </div>

            </form>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        // Importar módulos de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // Añadir 'deleteDoc' y 'updateDoc' para las nuevas funcionalidades
        import { getFirestore, doc, addDoc, onSnapshot, collection, query, where, getDocs, deleteDoc, updateDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Configuración Global y Variables de Estado
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        let app, db, auth, userId;
        const COLLECTION_PATH = `artifacts/${appId}/public/data/neonatal_records`;
        window.neonatalRecords = []; // Almacena todos los registros para análisis y exportación
        let chartInstance = null; // Instancia de Chart.js


        // --- Funciones de la UI ---
        function showMessage(elementId, text, isError = false) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = text;
                element.className = `mt-2 text-sm text-center ${isError ? 'text-red-600 font-semibold' : 'text-green-600'}`;
            }
        }

        window.openModal = (title, body, isError = true) => {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-title').className = `text-lg font-bold mb-3 ${isError ? 'text-red-600' : 'text-green-600'}`;
            document.getElementById('modal-body').textContent = body;
            document.getElementById('modal-container').classList.remove('hidden');
            document.getElementById('modal-container').classList.add('flex');
        };

        window.closeModal = () => {
            document.getElementById('modal-container').classList.remove('flex');
            document.getElementById('modal-container').classList.add('hidden');
        };

        window.closeEditModal = () => {
             document.getElementById('edit-modal-container').classList.remove('flex');
             document.getElementById('edit-modal-container').classList.add('hidden');
        };


        function renderSearchResults(record) {
            const resultsDiv = document.getElementById('search-results');
            if (!record) {
                resultsDiv.innerHTML = '<p class="text-red-500 font-semibold">No se encontró ningún registro con ese DNI/ID.</p>';
                return;
            }

            resultsDiv.innerHTML = `
                <div class="w-full text-left space-y-2">
                    <h4 class="text-lg font-bold text-gray-800">Registro Encontrado: ${record.dni}</h4>
                    <p><strong>Fecha Nacimiento:</strong> ${record.birthDate}</p>
                    <p><strong>Peso al Nacer:</strong> ${record.birthWeight} gr.</p>
                    <p><strong>Edad Gestacional:</strong> ${record.gestationalAge} sem.</p>
                    <p><strong>Tipo de Parto:</strong> ${record.deliveryType}</p>
                    <p><strong>Apgar:</strong> ${record.apgar}</p>
                    <p><strong>Días en Neo:</strong> ${record.nicuDays} días</p>
                    <p><strong>Edad Materna:</strong> ${record.maternalAge} años</p>
                    ${record.notes ? `<p><strong>Notas:</strong> ${record.notes}</p>` : ''}
                    <p class="text-xs text-gray-400">Registrado por ${record.userId.substring(0, 8)}... el ${new Date(record.createdAt).toLocaleDateString()}</p>
                    
                    <div class="flex space-x-3 pt-3">
                        <button onclick="startEdit('${record.id}')" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200 shadow-md">
                            Editar
                        </button>
                        <button onclick="deleteRecord('${record.id}', '${record.dni}')" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200 shadow-md">
                            Eliminar
                        </button>
                    </div>
                </div>
            `;
        }

        // --- Lógica de Análisis y Gráficos ---

        function calculateAverages(records) {
            const count = records.length;
            document.getElementById('record-count').textContent = count;
            // ... (El resto de la lógica de calculateAverages es la misma)

            if (count === 0) {
                document.getElementById('avg-birthWeight').textContent = '-';
                document.getElementById('avg-gestationalAge').textContent = '-';
                document.getElementById('avg-nicuDays').textContent = '-';
                document.getElementById('avg-maternalAge').textContent = '-';
                return;
            }

            const sumBirthWeight = records.reduce((sum, r) => sum + r.birthWeight, 0);
            const sumGestationalAge = records.reduce((sum, r) => sum + r.gestationalAge, 0);
            const sumNicuDays = records.reduce((sum, r) => sum + r.nicuDays, 0);
            const sumMaternalAge = records.reduce((sum, r) => sum + r.maternalAge, 0);

            document.getElementById('avg-birthWeight').textContent = (sumBirthWeight / count).toFixed(1);
            document.getElementById('avg-gestationalAge').textContent = (sumGestationalAge / count).toFixed(1);
            document.getElementById('avg-nicuDays').textContent = (sumNicuDays / count).toFixed(1);
            document.getElementById('avg-maternalAge').textContent = (sumMaternalAge / count).toFixed(1);
        }

        function renderChart(records) {
            const ctx = document.getElementById('birthWeightChart').getContext('2d');
            
            // 1. Obtener datos de peso y definir rangos (bins)
            const weights = records.map(r => r.birthWeight);
            const minWeight = 500; // Mínimo razonable
            const maxWeight = 5000; // Máximo razonable
            const binSize = 500;
            
            const bins = {};
            for (let i = minWeight; i < maxWeight; i += binSize) {
                bins[`${i}-${i + binSize - 1}`] = 0;
            }

            // 2. Contar frecuencias
            weights.forEach(w => {
                const binKey = Object.keys(bins).find(key => {
                    const [min, max] = key.split('-').map(Number);
                    return w >= min && w <= max;
                });
                if (binKey) {
                    bins[binKey]++;
                }
            });

            const labels = Object.keys(bins);
            const data = Object.values(bins);

            // 3. Destruir la instancia anterior si existe
            if (chartInstance) {
                chartInstance.destroy();
            }

            // 4. Crear el nuevo gráfico de barras (Histograma)
            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Número de Nacimientos',
                        data: data,
                        backgroundColor: 'rgba(79, 70, 229, 0.7)', // Indigo
                        borderColor: 'rgba(79, 70, 229, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        title: {
                            display: true,
                            text: 'Histograma de Peso al Nacer (gr.)',
                            font: { size: 16 }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Frecuencia' }
                        },
                        x: {
                            title: { display: true, text: 'Rango de Peso (gr.)' }
                        }
                    }
                }
            });
        }

        // --- Lógica de Exportación CSV ---

        window.exportToCSV = function() {
            // ... (La lógica de exportToCSV es la misma)
            if (window.neonatalRecords.length === 0) {
                openModal("Exportación Fallida", "No hay registros para exportar.", true);
                return;
            }

            const records = window.neonatalRecords;
            const headers = [
                "DNI", "Fecha_Nacimiento", "Peso_gr", "Edad_Gestacional_sem", 
                "Tipo_Parto", "Apgar", "Dias_Neo", "Edad_Materna", "Notas", 
                "Fecha_Registro", "ID_Usuario_Registro"
            ];

            // Mapear los nombres de campo de Firestore a los encabezados
            const keys = [
                "dni", "birthDate", "birthWeight", "gestationalAge", 
                "deliveryType", "apgar", "nicuDays", "maternalAge", "notes", 
                "createdAt", "userId"
            ];
            
            let csv = headers.join(',') + '\n';

            records.forEach(record => {
                const row = keys.map(key => {
                    let value = record[key];
                    if (key === 'createdAt') {
                        value = new Date(value).toISOString(); // Formato ISO para la fecha de registro
                    }
                    if (value === null || typeof value === 'undefined') {
                        value = '';
                    }
                    // Escapar comillas dobles y asegurarse de que el valor esté entre comillas si contiene comas
                    if (typeof value === 'string' && value.includes(',')) {
                        value = `"${value.replace(/"/g, '""')}"`;
                    }
                    return value;
                }).join(',');
                csv += row + '\n';
            });

            // Descargar el archivo
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", "registros_neonatales.csv");
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            openModal("Exportación Completa", "Los registros han sido exportados correctamente al archivo 'registros_neonatales.csv'.", false);
        }

        // --- Lógica de Firebase y CRUD Adicional ---

        async function initFirebase() {
            try {
                // VERIFICACIÓN CRÍTICA DE CONFIGURACIÓN
                if (Object.keys(firebaseConfig).length === 0) {
                    document.getElementById('loading-overlay').classList.add('hidden');
                    openModal(
                        "Error Fatal: Configuración Faltante", 
                        "La clave de API de Firebase no ha sido proporcionada por el entorno. Por favor, asegúrese de haber configurado su proyecto de Firebase según la guía.", 
                        true
                    );
                    // Salir de la inicialización si la configuración es incorrecta
                    return; 
                }
                
                setLogLevel('debug');
                
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // Autenticación
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                await new Promise((resolve) => {
                    const unsubscribe = onAuthStateChanged(auth, (user) => {
                        if (user) {
                            userId = user.uid;
                            document.getElementById('user-info').textContent = `ID de Usuario: ${userId} | Los datos son públicos para la app.`;
                            unsubscribe();
                            resolve();
                        } else {
                            console.error("No se pudo obtener el usuario autenticado.");
                            userId = crypto.randomUUID(); 
                            document.getElementById('user-info').textContent = `Sesión anónima (ID temporal): ${userId.substring(0, 8)}... | Los datos son públicos para la app.`;
                            unsubscribe();
                            resolve();
                        }
                    });
                });

                document.getElementById('loading-overlay').classList.add('hidden');
                document.getElementById('main-content').classList.remove('hidden');
                
                // Iniciar la escucha de registros en tiempo real
                loadRecords();

            } catch (error) {
                console.error("Error al inicializar Firebase o autenticar:", error);
                document.getElementById('loading-overlay').classList.add('hidden');
                openModal("Error Fatal", "No se pudo conectar a la base de datos. Detalle: " + error.message);
            }
        }

        function loadRecords() {
            const q = query(collection(db, COLLECTION_PATH));
            // ... (La lógica de loadRecords es la misma)

            onSnapshot(q, (snapshot) => {
                try {
                    const records = [];
                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        records.push({
                            id: doc.id,
                            ...data,
                            birthWeight: Number(data.birthWeight),
                            gestationalAge: Number(data.gestationalAge),
                            nicuDays: Number(data.nicuDays),
                            maternalAge: Number(data.maternalAge),
                            apgar: Number(data.apgar),
                        });
                    });
                    
                    window.neonatalRecords = records;
                    calculateAverages(records);
                    renderChart(records);

                } catch (error) {
                    console.error("Error al procesar los datos en tiempo real:", error);
                    showMessage('form-message', "Error al cargar/procesar promedios.", true);
                }
            }, (error) => {
                console.error("Error de onSnapshot (Firestore):", error);
                showMessage('form-message', "Error en la conexión en tiempo real.", true);
            });
        }


        async function saveRecord(event) {
            event.preventDefault();
            const saveBtn = document.getElementById('save-btn');
            saveBtn.disabled = true;
            showMessage('form-message', 'Verificando y guardando registro...', false);

            const recordData = {
                dni: document.getElementById('dni').value.trim(),
                birthDate: document.getElementById('birthDate').value,
                birthWeight: document.getElementById('birthWeight').value,
                gestationalAge: document.getElementById('gestationalAge').value,
                deliveryType: document.getElementById('deliveryType').value,
                apgar: document.getElementById('apgar').value,
                nicuDays: document.getElementById('nicuDays').value,
                maternalAge: document.getElementById('maternalAge').value,
                notes: document.getElementById('notes').value.trim(),
                createdAt: Date.now(),
                userId: userId, 
            };

            try {
                // Validación de Unicidad de DNI
                const dniQuery = query(
                    collection(db, COLLECTION_PATH),
                    where("dni", "==", recordData.dni)
                );
                
                const querySnapshot = await getDocs(dniQuery);

                if (!querySnapshot.empty) {
                    throw new Error(`El DNI/ID '${recordData.dni}' ya existe en la base de datos. No se puede guardar el registro duplicado.`);
                }
                
                // Añadir el nuevo documento
                await addDoc(collection(db, COLLECTION_PATH), recordData);
                
                showMessage('form-message', '¡Registro guardado exitosamente!', false);
                document.getElementById('neonatal-form').reset();
                
            } catch (error) {
                console.error("Error al guardar el registro:", error);
                const displayMessage = error.message.includes('DNI/ID') ? error.message : `Error al guardar: ${error.message}`;
                showMessage('form-message', displayMessage, true);
            } finally {
                saveBtn.disabled = false;
            }
        }

        window.searchRecord = async function() {
            // ... (La lógica de searchRecord es la misma, pero ahora llama a renderSearchResults con el ID)
            const searchDni = document.getElementById('search-dni').value.trim();
            const resultsDiv = document.getElementById('search-results');
            resultsDiv.innerHTML = '<p class="text-gray-500">Buscando...</p>';

            if (!searchDni) {
                resultsDiv.innerHTML = '<p class="text-red-500 font-semibold">Por favor, ingrese un DNI/ID para buscar.</p>';
                return;
            }

            try {
                const q = query(
                    collection(db, COLLECTION_PATH),
                    where("dni", "==", searchDni)
                );
                
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    renderSearchResults(null);
                } else {
                    const docData = querySnapshot.docs[0].data();
                    // Agregar el ID del documento para las funciones de edición/eliminación
                    docData.id = querySnapshot.docs[0].id; 
                    renderSearchResults(docData);
                }

            } catch (error) {
                console.error("Error en la búsqueda por DNI:", error);
                resultsDiv.innerHTML = `<p class="text-red-500 font-semibold">Error al realizar la búsqueda: ${error.message}</p>`;
            }
        }

        // --- FUNCIONALIDAD DE ELIMINAR (NUEVO) ---
        window.deleteRecord = async function(recordId, dni) {
            const confirmDelete = window.confirm(`¿Está seguro de que desea eliminar el registro con DNI/ID: ${dni}? Esta acción es irreversible.`);

            if (!confirmDelete) {
                return;
            }
            
            try {
                // Referencia al documento
                const docRef = doc(db, COLLECTION_PATH, recordId);
                await deleteDoc(docRef);

                // Limpiar la sección de búsqueda
                document.getElementById('search-results').innerHTML = '<p class="text-green-600 font-semibold">Registro eliminado exitosamente.</p>';
                document.getElementById('search-dni').value = '';

            } catch (error) {
                console.error("Error al eliminar el registro:", error);
                document.getElementById('search-results').innerHTML = `<p class="text-red-500 font-semibold">Error al eliminar: ${error.message}</p>`;
            }
        }

        // --- FUNCIONALIDAD DE EDICIÓN (NUEVO) ---
        window.startEdit = function(recordId) {
            // 1. Buscar el registro completo en la lista almacenada en memoria
            const record = window.neonatalRecords.find(r => r.id === recordId);
            
            if (!record) {
                openModal("Error", "No se encontró el registro para editar.", true);
                return;
            }

            // 2. Llenar el modal de edición con los datos actuales
            document.getElementById('edit-record-id').value = record.id;
            document.getElementById('edit-dni-display').textContent = record.dni;
            document.getElementById('edit-dni').value = record.dni; // Campo de sólo lectura

            document.getElementById('edit-birthDate').value = record.birthDate;
            document.getElementById('edit-birthWeight').value = record.birthWeight;
            document.getElementById('edit-gestationalAge').value = record.gestationalAge;
            document.getElementById('edit-apgar').value = record.apgar;
            document.getElementById('edit-maternalAge').value = record.maternalAge;
            document.getElementById('edit-deliveryType').value = record.deliveryType;
            document.getElementById('edit-nicuDays').value = record.nicuDays;
            document.getElementById('edit-notes').value = record.notes || '';
            
            // 3. Mostrar el modal
            document.getElementById('edit-modal-container').classList.add('flex');
            document.getElementById('edit-modal-container').classList.remove('hidden');
        }

        async function saveEdit(event) {
            event.preventDefault();
            const recordId = document.getElementById('edit-record-id').value;
            const saveBtn = document.getElementById('save-edit-btn');
            const messageDiv = document.getElementById('edit-form-message');
            
            saveBtn.disabled = true;
            messageDiv.textContent = 'Guardando cambios...';
            messageDiv.className = 'mt-2 text-sm text-center text-indigo-600';

            try {
                const updatedData = {
                    birthDate: document.getElementById('edit-birthDate').value,
                    birthWeight: document.getElementById('edit-birthWeight').value,
                    gestationalAge: document.getElementById('edit-gestationalAge').value,
                    deliveryType: document.getElementById('edit-deliveryType').value,
                    apgar: document.getElementById('edit-apgar').value,
                    nicuDays: document.getElementById('edit-nicuDays').value,
                    maternalAge: document.getElementById('edit-maternalAge').value,
                    notes: document.getElementById('edit-notes').value.trim(),
                    updatedAt: Date.now(), // Marca de tiempo de la edición
                };

                // Referencia al documento y actualizarlo
                const docRef = doc(db, COLLECTION_PATH, recordId);
                await updateDoc(docRef, updatedData);

                messageDiv.textContent = '¡Cambios guardados exitosamente!';
                messageDiv.className = 'mt-2 text-sm text-center text-green-600';
                
                // Cerrar el modal después de un breve momento
                setTimeout(closeEditModal, 1500);
                
                // Opcional: Volver a buscar el registro editado para actualizar la vista de búsqueda
                window.searchRecord();

            } catch (error) {
                console.error("Error al guardar la edición:", error);
                messageDiv.textContent = `Error al guardar: ${error.message}`;
                messageDiv.className = 'mt-2 text-sm text-center text-red-600 font-semibold';
            } finally {
                saveBtn.disabled = false;
            }
        }

        // Iniciar la aplicación
        document.addEventListener('DOMContentLoaded', () => {
            initFirebase();
            document.getElementById('neonatal-form').addEventListener('submit', saveRecord);
            document.getElementById('edit-neonatal-form').addEventListener('submit', saveEdit); // Listener para guardar edición
        });

    </script>
</body>
</html>
